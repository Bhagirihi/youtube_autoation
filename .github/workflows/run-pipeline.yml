# Horror Auto Factory — run full pipeline (story → audio → images → video → thumbnail)
# Scheduled: daily at 9:00 PM IST → pipeline + YouTube upload.
# Manual: workflow_dispatch with optional "Upload to YouTube".
#
# Shortcut: add ONE secret in Settings → Secrets → Actions:
#   ENV_FILE = entire contents of your .env file (copy-paste). All keys (Gemini, TTS, YouTube, etc.) in one go.
# Story mode: if ENV_FILE contains USE_TWO_STEP_STORY=1 → single prompt; if omitted → two-step (long story + metadata).
name: Run pipeline

on:
  schedule:
    # 9:00 PM IST (15:30 UTC) every day — runs pipeline and uploads to YouTube
    - cron: "30 15 * * *"
  workflow_dispatch:
    inputs:
      upload_to_youtube:
        description: "Upload video to YouTube after pipeline"
        required: false
        default: false
        type: boolean

env:
  DATA_DIR: ${{ github.workspace }}
  NODE_ENV: production

jobs:
  pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install system deps (ffmpeg)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg

      - name: Install npm dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install chromium --with-deps

      - name: Create working dirs
        run: |
          mkdir -p temp voiceover images output thumbnails

      # One secret: paste your full .env into repo secret "ENV_FILE" (Settings → Secrets → Actions).
      - name: Create .env from ENV_FILE secret
        id: create_env
        env:
          ENV_FILE: ${{ secrets.ENV_FILE }}
        run: |
          if [ -z "$ENV_FILE" ]; then
            echo "::error::Add repository secret ENV_FILE with your full .env contents (copy-paste from local .env)."
            exit 1
          fi
          printf '%s' "$ENV_FILE" > .env
          echo "Loaded .env from ENV_FILE secret"

      - name: Check YouTube auth
        id: yt_check
        run: |
          if grep -q '^YT_REFRESH_TOKEN=.' .env 2>/dev/null; then
            echo "has_yt_token=true" >> $GITHUB_OUTPUT
            echo "YouTube auth found in ENV_FILE; upload step will run when requested."
          else
            echo "has_yt_token=false" >> $GITHUB_OUTPUT
            echo "::notice::No YT_REFRESH_TOKEN in ENV_FILE — YouTube upload step will be skipped. Add it to the secret to enable uploads."
          fi

      - name: Run pipeline
        run: node index.js

      - name: Full story in job summary
        if: success()
        run: |
          echo "## Full story" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f temp/story.json ]; then
            echo "**Title:** $(jq -r '.title // "—"' temp/story.json)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "<details><summary>Click to expand full story</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<pre>" >> $GITHUB_STEP_SUMMARY
          if [ -f temp/story.txt ]; then
            # Escape HTML so </pre> in story doesn't break the block
            sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' temp/story.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "(story not found)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "</pre>" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Also available in **pipeline-output** artifact as \`temp/story.txt\` and \`temp/story.json\`." >> $GITHUB_STEP_SUMMARY

      - name: Upload to YouTube
        if: success() && (github.event_name == 'schedule' || github.event.inputs.upload_to_youtube == 'true') && steps.yt_check.outputs.has_yt_token == 'true'
        run: node scripts/uploadYoutubeFromCLI.js

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-output
          path: |
            output/final.mp4
            thumbnails/thumb.jpg
            temp/story.json
            temp/story.txt
          if-no-files-found: warn
