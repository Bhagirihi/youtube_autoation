# YouTube Automation – run pipeline on a schedule (no laptop needed).
# Uses run-scheduled.js; installs FFmpeg, yt-dlp; persists "already uploaded" lists via cache.
#
# Required secrets (Repo → Settings → Secrets and variables → Actions):
#   CINEPLOT_TOKEN_JSON   – contents of src/auth/CinePlotDecode.token.json (Shorts / CinePlot Decode)
#   GEMINI_API_KEY       – (for CinePlot Decode full / HPA) Gemini API key
# Optional for HPA:
#   HORROR_PODCAST_ADDA_TOKEN_JSON – contents of src/auth/HorrorPodcastAdda.token.json
# Add env vars for .env if needed (e.g. SUPADATA_API_KEY, UNSPLASH_ACCESS_KEY).
#
# Optional: GOOGLE_CLIENT_SECRET_JSON – contents of client_secret_....json if you don’t commit it.

name: YouTube Automation

on:
  schedule:
    # Tue, Thu, Sat, Sun only; 1 hr apart (IST = UTC+5:30). 0=Sun, 2=Tue, 4=Thu, 6=Sat
    # 13:30 UTC = 19:00 IST – Horror Podcast Adda
    - cron: "30 13 * * 0,2,4,6"
    # 14:30 UTC = 20:00 IST – CinePlot Decode (full)
    - cron: "30 14 * * 0,2,4,6"
    # 15:30 UTC = 21:00 IST – CinePlot Decode (Shorts)
    - cron: "30 15 * * 0,2,4,6"
  workflow_dispatch: # Manual run: choose channel or run all 3
    inputs:
      channel:
        description: "Channel to run (or leave empty to run all 3 in sequence)"
        required: false
        default: ""
        type: choice
        options:
          - ""
          - HorrorPodcastAdda
          - CinePlotDecode
          - CinePlotDecodeShorts

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install system deps (FFmpeg, yt-dlp)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp

      - name: Install Puppeteer/Chromium deps
        run: |
          sudo apt-get install -y --no-install-recommends \
            fonts-liberation libasound2 libatk-bridge2.0-0 libatk1.0-0 libcups2 \
            libdbus-1-3 libdrm2 libgbm1 libgtk-3-0 libnspr4 libnss3 libxcomposite1 \
            libxdamage1 libxfixes3 libxkbcommon0 libxrandr2 xdg-utils
        continue-on-error: true

      - name: Restore state (processed / uploaded lists)
        uses: actions/cache/restore@v4
        id: restore-state
        with:
          path: .github/yt-state
          key: yt-automation-state-v1

      - name: Place state files for run
        run: |
          mkdir -p .github/yt-state src/output/cinePlotDecode src/refDoc
          [ -f .github/yt-state/processed_videos.json ] && cp .github/yt-state/processed_videos.json src/output/cinePlotDecode/ || true
          [ -f .github/yt-state/uploaded_shorts.json ] && cp .github/yt-state/uploaded_shorts.json src/refDoc/ || true

      - name: Write YouTube tokens from secrets
        run: |
          mkdir -p src/auth
          echo "$CINEPLOT_TOKEN_JSON" > src/auth/CinePlotDecode.token.json
          if [ -n "$HORROR_PODCAST_ADDA_TOKEN_JSON" ]; then
            echo "$HORROR_PODCAST_ADDA_TOKEN_JSON" > src/auth/HorrorPodcastAdda.token.json
          fi
        env:
          CINEPLOT_TOKEN_JSON: ${{ secrets.CINEPLOT_TOKEN_JSON }}
          HORROR_PODCAST_ADDA_TOKEN_JSON: ${{ secrets.HORROR_PODCAST_ADDA_TOKEN_JSON }}

      - name: Write Google client secret (optional)
        run: |
          if [ -n "$GOOGLE_CLIENT_SECRET_JSON" ]; then
            echo "$GOOGLE_CLIENT_SECRET_JSON" > src/auth/client_secret_944372979454-a2ero9ndeopgpvvqidgauo1m8cqhr64k.apps.googleusercontent.com.json
          fi
        env:
          GOOGLE_CLIENT_SECRET_JSON: ${{ secrets.GOOGLE_CLIENT_SECRET_JSON }}

      - name: Install npm deps
        run: npm ci

      # Scheduled run: pick channel from cron. Manual run: use input or run all 3.
      - name: Set channel(s) to run
        id: channels
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            case "${{ github.event.schedule }}" in
              "30 13 * * 0,2,4,6") echo "channels=HorrorPodcastAdda" >> $GITHUB_OUTPUT ;;
              "30 14 * * 0,2,4,6") echo "channels=CinePlotDecode" >> $GITHUB_OUTPUT ;;
              *) echo "channels=CinePlotDecodeShorts" >> $GITHUB_OUTPUT ;;
            esac
          elif [ -n "${{ github.event.inputs.channel }}" ]; then
            echo "channels=${{ github.event.inputs.channel }}" >> $GITHUB_OUTPUT
          else
            echo "channels=HorrorPodcastAdda CinePlotDecode CinePlotDecodeShorts" >> $GITHUB_OUTPUT
          fi

      - name: Run pipeline(s) – post to YouTube
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          for ch in ${{ steps.channels.outputs.channels }}; do
            echo "=== Running $ch ==="
            CHANNEL="$ch" node run-scheduled.js || true
          done

      - name: Save state (processed / uploaded lists)
        if: always()
        run: |
          mkdir -p .github/yt-state
          [ -f src/output/cinePlotDecode/processed_videos.json ] && cp src/output/cinePlotDecode/processed_videos.json .github/yt-state/ || true
          [ -f src/refDoc/uploaded_shorts.json ] && cp src/refDoc/uploaded_shorts.json .github/yt-state/ || true

      - name: Cache state for next run
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .github/yt-state
          key: yt-automation-state-v1
