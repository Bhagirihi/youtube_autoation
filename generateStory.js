// generateStory.js
import { GoogleGenerativeAI } from "@google/generative-ai";
import {
  generateFolderFile,
  horrorPrompt,
  sleep,
} from "./utils/commonFunction.js";
import { promptStory, promptStoryUtils } from "./prompt.js";

function getRandomGeminiModel() {
  const models = ["gemini-1.5-flash", "gemini-2.5-flash", "gemini-2.5-pro"];

  const randomIndex = Math.floor(Math.random() * models.length);
  return models[randomIndex];
}

export default async function generateStory() {
  const GEMINI_KEY = process.env.GEMINI_API_KEY;
  if (!GEMINI_KEY) throw new Error("GEMINI_API_KEY missing");
  const randomModel = await getRandomGeminiModel();
  const gen = new GoogleGenerativeAI(GEMINI_KEY).getGenerativeModel({
    model: randomModel, //gemini-1.5-flash	1,000,000 gpt-3.5-turbo	16,385 gpt-4	8,192 gpt-4-32k	32,768 gpt-4o	128,000
    generationConfig: {
      temperature: 0.85 + Math.random() * 0.1, // add jitter
      //maxOutputTokens: 8192, // can go higher (up to ~32K+)
    },
    retryDelay: "30s",
  });
  await sleep(2000 + Math.random() * 3000); // 2‚Äì5 sec delay
  const storyPrompt = await promptStory();
  const dynamicPromptsStory = `${storyPrompt}\n\n// Generate story seed: ${Date.now()}`;

  const { response } = await gen.generateContent(dynamicPromptsStory.trim());
  const rawOut = await extractJSONBlock(response.text());

  const aiOutput = JSON.parse(rawOut);
  console.log("AI Output P1:", aiOutput);
  // const aiOutput = {
  //   title: "‡§ñ‡§Ç‡§°‡§π‡§∞ ‡§ï‡§æ ‡§∏‡§æ‡§Ø‡§æ üëª",
  //   intro:
  //     "‡§â‡§ú‡•ú‡•á ‡§π‡•Å‡§è, ‡§™‡•ç‡§∞‡§æ‡§ö‡•Ä‡§® ‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‡§ï‡•á ‡§ñ‡§Ç‡§°‡§π‡§∞‡•ã‡§Ç ‡§Æ‡•á‡§Ç, ‡§ú‡§π‡§æ‡§Ç ‡§∏‡§¶‡§ø‡§Ø‡•ã‡§Ç ‡§∏‡•á ‡§™‡§§‡•ç‡§•‡§∞‡•ã‡§Ç ‡§ï‡•Ä ‡§ñ‡§æ‡§Æ‡•ã‡§∂‡•Ä ‡§ó‡•Ç‡§Ç‡§ú‡§§‡•Ä ‡§π‡•à, ‡§è‡§ï ‡§õ‡•ã‡§ü‡•á ‡§∏‡•á ‡§ó‡§æ‡§Ç‡§µ ‡§ï‡•Ä ‡§ï‡§π‡§æ‡§®‡•Ä ‡§¨‡§∏‡§§‡•Ä ‡§π‡•à‡•§  ‡§Ø‡§π ‡§ó‡§æ‡§Ç‡§µ, '‡§ï‡§æ‡§≤‡•Ä ‡§®‡§¶‡•Ä' ‡§ï‡•á ‡§ï‡§ø‡§®‡§æ‡§∞‡•á ‡§¨‡§∏‡§æ ‡§π‡•à, ‡§ú‡§π‡§æ‡§Å ‡§π‡§∞ ‡§∞‡§æ‡§§ ‡§ö‡•Ä‡§ñ‡•ã‡§Ç ‡§ï‡•Ä ‡§Ü‡§µ‡§æ‡•õ‡•á‡§Ç ‡§π‡§µ‡§æ ‡§Æ‡•á‡§Ç ‡§ò‡•Å‡§≤ ‡§ú‡§æ‡§§‡•Ä ‡§π‡•à‡§Ç‡•§  ‡§ó‡§æ‡§Ç‡§µ ‡§ï‡•á ‡§≤‡•ã‡§ó ‡§∏‡§¶‡§ø‡§Ø‡•ã‡§Ç ‡§∏‡•á ‡§è‡§ï ‡§∞‡§π‡§∏‡•ç‡§Ø‡§Æ‡§Ø‡•Ä ‡§¨‡•Ä‡§Æ‡§æ‡§∞‡•Ä ‡§∏‡•á ‡§ú‡•Ç‡§ù ‡§∞‡§π‡•á ‡§π‡•à‡§Ç ‚Äì ‡§è‡§ï ‡§ê‡§∏‡•Ä ‡§¨‡•Ä‡§Æ‡§æ‡§∞‡•Ä ‡§ú‡•ã ‡§¶‡§ø‡§Æ‡§æ‡§ó ‡§ï‡•ã ‡§ß‡•Ä‡§∞‡•á-‡§ß‡•Ä‡§∞‡•á ‡§ñ‡•ã‡§ñ‡§≤‡§æ ‡§ï‡§∞ ‡§¶‡•á‡§§‡•Ä ‡§π‡•à, ‡§Ø‡§æ‡§¶‡§¶‡§æ‡§∂‡•ç‡§§ ‡§õ‡•Ä‡§® ‡§≤‡•á‡§§‡•Ä ‡§π‡•à, ‡§î‡§∞ ‡§Ö‡§Ç‡§§ ‡§Æ‡•á‡§Ç,  ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø ‡§ï‡•ã ‡§™‡§æ‡§ó‡§≤‡§™‡§® ‡§ï‡•Ä ‡§ó‡§π‡§∞‡§æ‡§à ‡§Æ‡•á‡§Ç ‡§≤‡•á ‡§ú‡§æ‡§§‡•Ä ‡§π‡•à‡•§  ‡§á‡§∏ ‡§¨‡•Ä‡§Æ‡§æ‡§∞‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§π‡•à '‡§õ‡§æ‡§Ø‡§æ'‡•§  ‡§Ø‡§π ‡§õ‡§æ‡§Ø‡§æ, ‡§ñ‡§Ç‡§°‡§π‡§∞‡•ã‡§Ç ‡§∏‡•á ‡§®‡§ø‡§ï‡§≤‡§§‡•Ä ‡§π‡•à, ‡§∞‡§æ‡§§ ‡§ï‡•á ‡§Ö‡§Ç‡§ß‡•á‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ó‡§æ‡§Ç‡§µ ‡§™‡§∞ ‡§õ‡§æ ‡§ú‡§æ‡§§‡•Ä ‡§π‡•à, ‡§î‡§∞ ‡§Ö‡§™‡§®‡•á ‡§∂‡§ø‡§ï‡§æ‡§∞ ‡§ï‡•ã ‡§ö‡•Å‡§®‡§§‡•Ä ‡§π‡•à‡•§  ‡§è‡§ï ‡§Ø‡•Å‡§µ‡§æ ‡§≤‡•ú‡§ï‡•Ä, ‡§∏‡•Ä‡§§‡§æ, ‡§Ö‡§™‡§®‡•á ‡§¶‡§æ‡§¶‡§æ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§á‡§∏‡•Ä ‡§ó‡§æ‡§Ç‡§µ ‡§Æ‡•á‡§Ç ‡§∞‡§π‡§§‡•Ä ‡§π‡•à, ‡§ú‡•ã ‡§ñ‡•Å‡§¶ ‡§á‡§∏‡•Ä ‡§¨‡•Ä‡§Æ‡§æ‡§∞‡•Ä ‡§∏‡•á ‡§™‡•Ä‡•ú‡§ø‡§§ ‡§π‡•à‡•§  ‡§¶‡§æ‡§¶‡§æ ‡§ï‡•á ‡§¨‡§æ‡§∞-‡§¨‡§æ‡§∞ ‡§Ü‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§≠‡§Ø‡§æ‡§®‡§ï ‡§∏‡§™‡§®‡•á, ‡§â‡§®‡§ï‡•Ä ‡§¨‡•á‡§ö‡•à‡§®‡•Ä, ‡§î‡§∞ ‡§ó‡§æ‡§Ç‡§µ ‡§ï‡•Ä  ‡§Ö‡§ú‡•Ä‡§¨‡•ã‡§ó‡§∞‡•Ä‡§¨ ‡§ö‡•Å‡§™‡•ç‡§™‡•Ä ‡§∏‡•Ä‡§§‡§æ ‡§ï‡•á ‡§Æ‡§® ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§≠‡§Ø‡§æ‡§µ‡§π ‡§°‡§∞ ‡§™‡•à‡§¶‡§æ ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à, ‡§è‡§ï ‡§ê‡§∏‡§æ ‡§°‡§∞ ‡§ú‡•ã ‡§â‡§∏‡•á ‡§ñ‡§Ç‡§°‡§π‡§∞‡•ã‡§Ç ‡§ï‡•á ‡§∞‡§π‡§∏‡•ç‡§Ø ‡§ï‡•Ä ‡§ì‡§∞ ‡§ñ‡•Ä‡§Ç‡§ö‡§§‡§æ ‡§π‡•à‡•§",
  //   build_up:
  //     "‡§∏‡•Ä‡§§‡§æ ‡§ï‡•á ‡§¶‡§æ‡§¶‡§æ, ‡§∞‡§æ‡§Æ‡§¶‡§æ‡§∏, ‡§è‡§ï ‡§∏‡§Æ‡§Ø ‡§ó‡§æ‡§Ç‡§µ ‡§ï‡•á ‡§∏‡§¨‡§∏‡•á ‡§¨‡•Å‡§¶‡•ç‡§ß‡§ø‡§Æ‡§æ‡§® ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø ‡§•‡•á, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ö‡§¨ ‡§â‡§®‡§ï‡•Ä ‡§Ü‡§Å‡§ñ‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§Ö‡§ú‡•Ä‡§¨ ‡§∏‡•Ä ‡§ñ‡§æ‡§≤‡•Ä‡§™‡§® ‡§π‡•à‡•§  ‡§µ‡•ã ‡§∞‡§æ‡§§ ‡§ï‡•ã ‡§¨‡§æ‡§∞-‡§¨‡§æ‡§∞ ‡§ú‡§æ‡§ó‡§§‡•á ‡§π‡•à‡§Ç,  ‡§Ö‡§™‡§®‡•á ‡§π‡§æ‡§•‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§ï‡§∏‡§ï‡§∞ ‡§è‡§ï ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä, ‡§´‡§ü‡•Ä ‡§π‡•Å‡§à ‡§ï‡§ø‡§§‡§æ‡§¨ ‡§™‡§ï‡•ú‡•á ‡§π‡•Å‡§è,  ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§õ ‡§Ö‡§ú‡•Ä‡§¨‡•ã‡§ó‡§∞‡•Ä‡§¨ ‡§ö‡§ø‡§§‡•ç‡§∞ ‡§î‡§∞ ‡§≤‡§ø‡§ñ‡§æ‡§µ‡§ü ‡§π‡•à‡•§  ‡§∏‡•Ä‡§§‡§æ ‡§®‡•á ‡§ï‡§à ‡§¨‡§æ‡§∞ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡•Ä ‡§π‡•à ‡§ï‡§ø ‡§µ‡§π ‡§ï‡§ø‡§§‡§æ‡§¨ ‡§ï‡•ã ‡§™‡•ù‡•á, ‡§≤‡•á‡§ï‡§ø‡§® ‡§µ‡§π ‡§â‡§∏‡•á ‡§∏‡§Æ‡§ù ‡§®‡§π‡•Ä‡§Ç ‡§™‡§æ‡§§‡•Ä‡•§  ‡§ó‡§æ‡§Ç‡§µ ‡§ï‡•á ‡§Ö‡§®‡•ç‡§Ø ‡§≤‡•ã‡§ó ‡§≠‡•Ä ‡§á‡§∏‡•Ä ‡§§‡§∞‡§π ‡§ï‡•Ä ‡§¨‡•Ä‡§Æ‡§æ‡§∞‡•Ä ‡§∏‡•á ‡§ó‡•ç‡§∞‡§∏‡•ç‡§§ ‡§π‡•à‡§Ç ‚Äì ‡§â‡§®‡§ï‡•Ä ‡§Ü‡§Å‡§ñ‡•á‡§Ç ‡§ñ‡§æ‡§≤‡•Ä, ‡§ö‡•á‡§π‡§∞‡•á ‡§Æ‡•Å‡§∞‡§ù‡§æ‡§è, ‡§î‡§∞ ‡§π‡§∞ ‡§µ‡•ò‡•ç‡§§ ‡§è‡§ï ‡§ó‡§π‡§∞‡•á ‡§°‡§∞ ‡§∏‡•á ‡§∏‡§∞‡§æ‡§¨‡•ã‡§∞‡•§  ‡§ó‡§æ‡§Ç‡§µ ‡§ï‡•á ‡§¨‡§æ‡§π‡§∞, ‡§ï‡§æ‡§≤‡•Ä ‡§®‡§¶‡•Ä ‡§ï‡§æ ‡§™‡§æ‡§®‡•Ä ‡§∏‡§¶‡§ø‡§Ø‡•ã‡§Ç ‡§∏‡•á ‡§ï‡§æ‡§≤‡§æ ‡§î‡§∞ ‡§ó‡§Ç‡§¶‡§æ ‡§π‡•à,  ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§Ö‡§ú‡•Ä‡§¨ ‡§∏‡•Ä ‡§¨‡•Ç ‡§Ü‡§§‡•Ä ‡§π‡•à‡•§  ‡§∞‡§æ‡§§ ‡§ï‡•ã, ‡§®‡§¶‡•Ä ‡§ï‡•á ‡§ï‡§ø‡§®‡§æ‡§∞‡•á ‡§è‡§ï ‡§Ö‡§ú‡•Ä‡§¨ ‡§∏‡•Ä ‡§´‡•Å‡§∏‡§´‡•Å‡§∏‡§æ‡§π‡§ü ‡§∏‡•Å‡§®‡§æ‡§à ‡§¶‡•á‡§§‡•Ä ‡§π‡•à, ‡§ú‡•ã ‡§∏‡•Ä‡§§‡§æ ‡§ï‡•á ‡§¶‡§ø‡§≤ ‡§Æ‡•á‡§Ç ‡§î‡§∞ ‡§°‡§∞ ‡§≠‡§∞ ‡§¶‡•á‡§§‡•Ä ‡§π‡•à‡•§  ‡§µ‡§π ‡§Ö‡§™‡§®‡•á ‡§¶‡§æ‡§¶‡§æ ‡§ï‡•á ‡§∏‡§™‡§®‡•ã‡§Ç ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§®‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§µ‡§π ‡§ï‡•á‡§µ‡§≤ ‡§¨‡•ú‡§¨‡•ú‡§æ‡§§‡•á ‡§π‡•Å‡§è,  ‡§Ö‡§™‡§®‡•á ‡§≠‡§Ø‡§æ‡§µ‡§π ‡§Ö‡§®‡•Å‡§≠‡§µ‡•ã‡§Ç ‡§ï‡•á ‡§ï‡•Å‡§õ ‡§ü‡•Å‡§ï‡•ú‡•á ‡§π‡•Ä ‡§¨‡§§‡§æ ‡§™‡§æ‡§§‡•á ‡§π‡•à‡§Ç, ‡§ú‡•à‡§∏‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§Ö‡§¶‡•É‡§∂‡•ç‡§Ø ‡§∂‡§ï‡•ç‡§§‡§ø ‡§∏‡•á ‡§ò‡§ø‡§∞‡•á ‡§π‡•ã‡§®‡•á ‡§ï‡§æ, ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡§Ø‡§æ‡§®‡§ï ‡§õ‡§æ‡§Ø‡§æ ‡§∏‡•á ‡§™‡•Ä‡§õ‡§æ ‡§ï‡§ø‡§è ‡§ú‡§æ‡§®‡•á ‡§ï‡§æ‡•§  ‡§ó‡§æ‡§Ç‡§µ ‡§ï‡•á ‡§è‡§ï ‡§¨‡•Ç‡•ù‡•á ‡§®‡•á ‡§¨‡§§‡§æ‡§Ø‡§æ ‡§ï‡§ø ‡§Ø‡§π ‡§õ‡§æ‡§Ø‡§æ, ‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‡§ï‡•á ‡§ñ‡§Ç‡§°‡§π‡§∞‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§¨‡§∏‡•Ä ‡§è‡§ï ‡§™‡•ç‡§∞‡§æ‡§ö‡•Ä‡§® ‡§Ü‡§§‡•ç‡§Æ‡§æ ‡§π‡•à, ‡§ú‡•ã ‡§Ö‡§™‡§®‡•á ‡§∂‡§ø‡§ï‡§æ‡§∞ ‡§ï‡•Ä ‡§Ø‡§æ‡§¶‡§¶‡§æ‡§∂‡•ç‡§§ ‡§ï‡•ã ‡§ö‡•Å‡§∞‡§æ‡§ï‡§∞, ‡§â‡§∏‡•á ‡§Ö‡§™‡§®‡•á ‡§Ü‡§™ ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§æ‡§π‡§ø‡§§ ‡§ï‡§∞ ‡§≤‡•á‡§§‡•Ä ‡§π‡•à‡•§",
  //   suspense:
  //     "‡§∏‡•Ä‡§§‡§æ, ‡§Ö‡§™‡§®‡•á ‡§¶‡§æ‡§¶‡§æ ‡§ï‡•Ä ‡§Æ‡§¶‡§¶ ‡§ï‡§∞‡§®‡•á ‡§î‡§∞ ‡§á‡§∏ ‡§∞‡§π‡§∏‡•ç‡§Ø ‡§ï‡•ã ‡§∏‡•Å‡§≤‡§ù‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§ñ‡§Ç‡§°‡§π‡§∞‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§§‡•Ä ‡§π‡•à‡•§  ‡§µ‡§π‡§æ‡§Ç,  ‡§â‡§∏‡•á  ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‡§ï‡•á ‡§Ö‡§µ‡§∂‡•á‡§∑,  ‡§ü‡•Ç‡§ü‡•á ‡§π‡•Å‡§è ‡§∏‡•ç‡§§‡§Ç‡§≠, ‡§î‡§∞ ‡§Ö‡§Ç‡§ß‡•á‡§∞‡•á ‡§ï‡•ã‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç  ‡§õ‡§ø‡§™‡•á ‡§π‡•Å‡§è  ‡§≠‡§Ø‡§æ‡§®‡§ï ‡§ö‡§ø‡§§‡•ç‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§§‡•á ‡§π‡•à‡§Ç‡•§  ‡§π‡§µ‡§æ ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§Ö‡§ú‡•Ä‡§¨ ‡§∏‡•Ä ‡§†‡§Ç‡§°‡§ï ‡§π‡•à, ‡§î‡§∞  ‡§è‡§ï ‡§¶‡§¨‡•Ä ‡§π‡•Å‡§à ‡§ö‡•Ä‡§ñ ‡§ï‡•Ä ‡§Ü‡§µ‡§æ‡•õ  ‡§â‡§∏‡§ï‡•á ‡§ï‡§æ‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§ó‡•Ç‡§Ç‡§ú‡§§‡•Ä ‡§π‡•à‡•§  ‡§µ‡§π ‡§Ö‡§™‡§®‡•á ‡§¶‡§æ‡§¶‡§æ ‡§ï‡•Ä ‡§ï‡§ø‡§§‡§æ‡§¨ ‡§Æ‡•á‡§Ç ‡§¨‡§§‡§æ‡§è ‡§ó‡§è ‡§ö‡§ø‡§§‡•ç‡§∞‡•ã‡§Ç ‡§ï‡•ã ‡§ñ‡§Ç‡§°‡§π‡§∞‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§¢‡•Ç‡§Ç‡§¢‡§®‡•á ‡§≤‡§ó‡§§‡•Ä ‡§π‡•à,  ‡§î‡§∞ ‡§ú‡•à‡§∏‡•á-‡§ú‡•à‡§∏‡•á ‡§µ‡§π ‡§Ü‡§ó‡•á ‡§¨‡•ù‡§§‡•Ä ‡§π‡•à,  ‡§â‡§∏‡•á ‡§è‡§ï ‡§Ö‡§ú‡•Ä‡§¨ ‡§∏‡§æ ‡§è‡§π‡§∏‡§æ‡§∏ ‡§π‡•ã‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§µ‡§π ‡§ñ‡§Ç‡§°‡§π‡§∞‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§Ö‡§ï‡•á‡§≤‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§  ‡§è‡§ï ‡§Ö‡§¶‡•É‡§∂‡•ç‡§Ø ‡§∂‡§ï‡•ç‡§§‡§ø ‡§â‡§∏‡§ï‡§æ ‡§™‡•Ä‡§õ‡§æ ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à, ‡§â‡§∏‡§ï‡•Ä ‡§∏‡§æ‡§Ç‡§∏‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§†‡§Ç‡§°‡§ï ‡§ò‡•ã‡§≤ ‡§¶‡•á‡§§‡•Ä ‡§π‡•à‡•§  ‡§µ‡§π ‡§¨‡§æ‡§∞-‡§¨‡§æ‡§∞  ‡§Ö‡§™‡§®‡•á ‡§¶‡§æ‡§¶‡§æ ‡§ï‡§æ ‡§ö‡•á‡§π‡§∞‡§æ ‡§¶‡•á‡§ñ‡§§‡•Ä ‡§π‡•à, ‡§ú‡•ã ‡§â‡§∏‡§∏‡•á ‡§Æ‡§¶‡§¶ ‡§Æ‡§æ‡§Ç‡§ó ‡§∞‡§π‡§æ ‡§π‡•à‡•§  ‡§â‡§∏‡•á ‡§ï‡•Å‡§õ ‡§Ö‡§ú‡•Ä‡§¨‡•ã‡§ó‡§∞‡•Ä‡§¨ ‡§Ü‡§µ‡§æ‡•õ‡•á‡§Ç ‡§∏‡•Å‡§®‡§æ‡§à ‡§¶‡•á‡§§‡•Ä ‡§π‡•à‡§Ç -  ‡§´‡•Å‡§∏‡§´‡•Å‡§∏‡§æ‡§π‡§ü‡•á‡§Ç,  ‡§π‡§Å‡§∏‡•Ä,  ‡§î‡§∞ ‡§ö‡•Ä‡§ñ‡•á‡§Ç ‚Äì ‡§ú‡•ã ‡§â‡§∏‡§ï‡•á ‡§Æ‡§® ‡§Æ‡•á‡§Ç ‡§≠‡§Ø‡§æ‡§®‡§ï ‡§°‡§∞ ‡§™‡•à‡§¶‡§æ ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à‡§Ç‡•§  ‡§µ‡§π  ‡§ñ‡§Ç‡§°‡§π‡§∞‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§≠‡§ü‡§ï‡§§‡•Ä ‡§∞‡§π‡§§‡•Ä ‡§π‡•à,  ‡§Ö‡§™‡§®‡•á ‡§°‡§∞ ‡§∏‡•á ‡§ú‡•Ç‡§ù‡§§‡•Ä ‡§π‡•Å‡§à,  ‡§î‡§∞ ‡§â‡§∏‡•á ‡§è‡§ï  ‡§Ö‡§ú‡•Ä‡§¨ ‡§∏‡§æ ‡§è‡§π‡§∏‡§æ‡§∏ ‡§π‡•ã‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§â‡§∏‡§ï‡•Ä ‡§Ö‡§™‡§®‡•Ä ‡§Ø‡§æ‡§¶‡§¶‡§æ‡§∂‡•ç‡§§ ‡§≠‡•Ä ‡§ß‡•Å‡§Ç‡§ß‡§≤‡•Ä ‡§π‡•ã‡§§‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à‡•§  ‡§µ‡§π ‡§Ö‡§™‡§®‡•á ‡§Ü‡§™ ‡§ï‡•ã ‡§ñ‡•ã‡§§‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à,  ‡§õ‡§æ‡§Ø‡§æ ‡§ï‡•á ‡§ß‡•Ä‡§∞‡•á-‡§ß‡•Ä‡§∞‡•á ‡§Ö‡§™‡§®‡•á ‡§∂‡§ø‡§ï‡§æ‡§∞ ‡§ï‡•ã ‡§®‡§ø‡§ó‡§≤‡§®‡•á ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡§æ ‡§∂‡§ø‡§ï‡§æ‡§∞ ‡§¨‡§®‡§§‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à‡•§",
  //   twist:
  //     "‡§Ö‡§Ç‡§§ ‡§Æ‡•á‡§Ç, ‡§∏‡•Ä‡§§‡§æ ‡§è‡§ï ‡§ó‡•Å‡§™‡•ç‡§§ ‡§ï‡§ï‡•ç‡§∑ ‡§Æ‡•á‡§Ç ‡§™‡§π‡•Å‡§Å‡§ö‡§§‡•Ä ‡§π‡•à, ‡§ú‡§π‡§æ‡§Å ‡§â‡§∏‡•á ‡§è‡§ï  ‡§≠‡§Ø‡§æ‡§®‡§ï ‡§∏‡§ö‡•ç‡§ö‡§æ‡§à ‡§ï‡§æ ‡§™‡§§‡§æ ‡§ö‡§≤‡§§‡§æ ‡§π‡•à‡•§  ‡§µ‡§π  ‡§¶‡•á‡§ñ‡§§‡•Ä ‡§π‡•à ‡§ï‡§ø  '‡§õ‡§æ‡§Ø‡§æ'  ‡§ï‡•ã‡§à ‡§Ü‡§§‡•ç‡§Æ‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§¨‡§≤‡•ç‡§ï‡§ø  ‡§è‡§ï  ‡§™‡•ç‡§∞‡§æ‡§ö‡•Ä‡§®  ‡§∂‡§æ‡§™ ‡§π‡•à,  ‡§ú‡•ã  ‡§ï‡§æ‡§≤‡•Ä ‡§®‡§¶‡•Ä ‡§ï‡•á ‡§™‡§æ‡§®‡•Ä ‡§Æ‡•á‡§Ç ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à‡•§  ‡§Ø‡§π ‡§™‡§æ‡§®‡•Ä,  ‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‡§ï‡•á ‡§ñ‡§Ç‡§°‡§π‡§∞‡•ã‡§Ç ‡§ï‡•á ‡§®‡•Ä‡§ö‡•á ‡§∏‡•á ‡§¨‡§π‡§§‡§æ ‡§π‡•à, ‡§î‡§∞  ‡§á‡§∏‡§Æ‡•á‡§Ç ‡§è‡§ï  ‡§µ‡§ø‡§∑‡§æ‡§ï‡•ç‡§§ ‡§™‡§¶‡§æ‡§∞‡•ç‡§•  ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à,  ‡§ú‡•ã  ‡§ß‡•Ä‡§∞‡•á-‡§ß‡•Ä‡§∞‡•á  ‡§Æ‡§æ‡§®‡§µ ‡§Æ‡§∏‡•ç‡§§‡§ø‡§∑‡•ç‡§ï ‡§ï‡•ã ‡§®‡§∑‡•ç‡§ü ‡§ï‡§∞ ‡§¶‡•á‡§§‡§æ ‡§π‡•à‡•§  ‡§î‡§∞ ‡§∏‡§¨‡§∏‡•á ‡§≠‡§Ø‡§æ‡§®‡§ï ‡§¨‡§æ‡§§ ‡§Ø‡§π ‡§π‡•à ‡§ï‡§ø,  ‡§Ø‡§π ‡§∂‡§æ‡§™  ‡§™‡•Ä‡•ù‡•Ä ‡§¶‡§∞ ‡§™‡•Ä‡•ù‡•Ä  ‡§ó‡§æ‡§Ç‡§µ ‡§ï‡•á ‡§≤‡•ã‡§ó‡•ã‡§Ç ‡§ï‡•ã ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à,  ‡§î‡§∞  ‡§â‡§®‡§ï‡•Ä ‡§Ø‡§æ‡§¶‡§¶‡§æ‡§∂‡•ç‡§§ ‡§ï‡•ã ‡§ö‡•Å‡§∞‡§æ‡§ï‡§∞,  ‡§Ö‡§™‡§®‡•Ä  ‡§∂‡§ï‡•ç‡§§‡§ø ‡§ï‡•ã ‡§¨‡•ù‡§æ‡§§‡§æ ‡§π‡•à‡•§  ‡§∏‡•Ä‡§§‡§æ  ‡§∏‡§Æ‡§ù‡§§‡•Ä ‡§π‡•à ‡§ï‡§ø  ‡§â‡§∏‡§ï‡•á ‡§¶‡§æ‡§¶‡§æ  ‡§î‡§∞  ‡§ó‡§æ‡§Ç‡§µ ‡§ï‡•á ‡§Ö‡§®‡•ç‡§Ø ‡§≤‡•ã‡§ó  ‡§á‡§∏ ‡§∂‡§æ‡§™ ‡§ï‡•á ‡§∂‡§ø‡§ï‡§æ‡§∞ ‡§π‡•à‡§Ç,  ‡§î‡§∞  ‡§µ‡§π  ‡§ñ‡•Å‡§¶ ‡§≠‡•Ä  ‡§á‡§∏ ‡§∂‡§æ‡§™ ‡§∏‡•á  ‡§Æ‡•Å‡§ï‡•ç‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§  ‡§µ‡§π  ‡§Ö‡§™‡§®‡•Ä  ‡§Ø‡§æ‡§¶‡§¶‡§æ‡§∂‡•ç‡§§  ‡§ñ‡•ã‡§®‡•á  ‡§≤‡§ó‡§§‡•Ä ‡§π‡•à,  ‡§î‡§∞  ‡§â‡§∏‡•á  ‡§Ö‡§™‡§®‡•á  ‡§°‡§∞  ‡§î‡§∞  ‡§π‡§ï‡•Ä‡§ï‡§§  ‡§ï‡•á  ‡§¨‡•Ä‡§ö  ‡§´‡§∞‡•ç‡§ï  ‡§ï‡§∞‡§®‡§æ  ‡§Æ‡•Å‡§∂‡•ç‡§ï‡§ø‡§≤  ‡§π‡•ã  ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§",
  //   ending_line:
  //     "‡§∏‡•Ä‡§§‡§æ, ‡§ñ‡§Ç‡§°‡§π‡§∞‡•ã‡§Ç ‡§ï‡•á ‡§Ö‡§Ç‡§ß‡•á‡§∞‡•á ‡§Æ‡•á‡§Ç,  ‡§Ö‡§™‡§®‡•á ‡§¶‡§æ‡§¶‡§æ ‡§ï‡•Ä ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§ï‡§ø‡§§‡§æ‡§¨ ‡§ï‡•á  ‡§è‡§ï ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§™‡§®‡•ç‡§®‡•á ‡§™‡§∞  ‡§è‡§ï  ‡§≠‡§Ø‡§æ‡§µ‡§π ‡§ö‡§ø‡§§‡•ç‡§∞ ‡§¶‡•á‡§ñ‡§§‡•Ä ‡§π‡•à ‚Äì  ‡§è‡§ï ‡§ö‡§ø‡§§‡•ç‡§∞ ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç  ‡§µ‡§π  ‡§ñ‡•Å‡§¶  ‡§≠‡•Ä  ‡§â‡§∏  ‡§≠‡§Ø‡§æ‡§µ‡§π  ‡§õ‡§æ‡§Ø‡§æ  ‡§ï‡§æ  ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ  ‡§¨‡§®  ‡§ö‡•Å‡§ï‡•Ä  ‡§π‡•à,  ‡§â‡§∏‡§ï‡•á  ‡§ö‡•á‡§π‡§∞‡•á  ‡§™‡§∞  ‡§µ‡§π‡•Ä  ‡§ñ‡§æ‡§≤‡•Ä‡§™‡§®  ‡§π‡•à  ‡§ú‡•ã  ‡§â‡§∏‡§ï‡•á  ‡§¶‡§æ‡§¶‡§æ  ‡§ï‡•Ä  ‡§Ü‡§Å‡§ñ‡•ã‡§Ç  ‡§Æ‡•á‡§Ç  ‡§•‡§æ‡•§  ‡§î‡§∞  ‡§ú‡•à‡§∏‡•á ‡§π‡•Ä  ‡§â‡§∏‡§ï‡•Ä  ‡§Ü‡§Å‡§ñ‡•á‡§Ç  ‡§¨‡§Ç‡§¶  ‡§π‡•ã‡§§‡•Ä  ‡§π‡•à‡§Ç,  ‡§ï‡§æ‡§≤‡•Ä  ‡§®‡§¶‡•Ä  ‡§ï‡•Ä  ‡§´‡•Å‡§∏‡§´‡•Å‡§∏‡§æ‡§π‡§ü  ‡§â‡§∏‡§ï‡•á  ‡§ï‡§æ‡§®‡•ã‡§Ç  ‡§Æ‡•á‡§Ç  ‡§ó‡•Ç‡§Ç‡§ú‡§§‡•Ä  ‡§∞‡§π‡§§‡•Ä  ‡§π‡•à,  ‡§è‡§ï  ‡§ê‡§∏‡§æ  ‡§≠‡§Ø‡§æ‡§µ‡§π  ‡§µ‡§æ‡§¶‡§æ  ‡§ï‡§∞‡§§‡•Ä  ‡§π‡•Å‡§à  ‡§ú‡•ã  ‡§™‡•Ä‡•ù‡§ø‡§Ø‡•ã‡§Ç  ‡§§‡§ï  ‡§ó‡§æ‡§Ç‡§µ  ‡§™‡§∞  ‡§õ‡§æ‡§Ø‡§æ  ‡§∞‡§π‡•á‡§ó‡§æ,  ‡§è‡§ï  ‡§Ö‡§¶‡•É‡§∂‡•ç‡§Ø  ‡§õ‡§æ‡§Ø‡§æ  ‡§ú‡•ã  ‡§Ø‡§æ‡§¶‡§¶‡§æ‡§∂‡•ç‡§§  ‡§ï‡•ã  ‡§ö‡•Å‡§∞‡§æ‡§§‡•Ä  ‡§π‡•à,  ‡§î‡§∞  ‡§Æ‡§®  ‡§ï‡•ã  ‡§ñ‡•ã‡§ñ‡§≤‡§æ  ‡§ï‡§∞  ‡§¶‡•á‡§§‡•Ä  ‡§π‡•à,  ‡§è‡§ï  ‡§Ö‡§®‡§Ç‡§§  ‡§ö‡§ï‡•ç‡§∞  ‡§ú‡•ã  ‡§ï‡§≠‡•Ä  ‡§®‡§π‡•Ä‡§Ç  ‡§ü‡•Ç‡§ü‡•á‡§ó‡§æ,  ‡§è‡§ï  ‡§Ö‡§®‡§Ç‡§§  ‡§≠‡§Ø‡§æ‡§µ‡§π  ‡§∏‡§™‡§®‡§æ  ‡§ú‡§ø‡§∏‡§∏‡•á  ‡§ï‡•ã‡§à  ‡§≠‡•Ä  ‡§Æ‡•Å‡§ï‡•ç‡§§  ‡§®‡§π‡•Ä‡§Ç  ‡§π‡•ã  ‡§∏‡§ï‡§§‡§æ‡•§",
  //   image_tags: [
  //     "A close-up of a cracked, ancient book with unsettling illustrations, held in trembling hands.",
  //     "A young girl, silhouetted against the moonlit ruins of a temple, looking terrified.",
  //     "The dilapidated temple at night, shrouded in mist, with an eerie glow emanating from within.",
  //     "A wide shot of a village nestled beside a dark, ominous river.",
  //     "Close-up on the eyes of an old man, vacant and filled with a haunting emptiness.",
  //     "Reflective, black water of the Kali River, with strange whispers seeming to rise from its depths.",
  //     "A crumbling stone statue within the temple ruins, partially obscured by shadows.",
  //     "The girl discovering a hidden chamber within the ruins, with a sense of impending dread.",
  //     "A shadowy figure lurking in the background, its presence barely perceptible.",
  //     "A hand reaching out from the darkness, grasping at the girl's arm.",
  //   ],
  //   description:
  //     "‡§è‡§ï ‡§ñ‡§Ç‡§°‡§π‡§∞ ‡§Æ‡•á‡§Ç ‡§¶‡§¨‡•á ‡§™‡•ç‡§∞‡§æ‡§ö‡•Ä‡§® ‡§∂‡•ç‡§∞‡§æ‡§™ ‡§ï‡•Ä ‡§ï‡§π‡§æ‡§®‡•Ä... ‡§Ø‡§æ‡§¶‡§¶‡§æ‡§∂‡•ç‡§§ ‡§ö‡•Å‡§∞‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§õ‡§æ‡§Ø‡§æ ‡§ï‡§æ ‡§∏‡§æ‡§Ø‡§æ... ‡§ï‡•ç‡§Ø‡§æ ‡§∏‡•Ä‡§§‡§æ ‡§¨‡§ö ‡§™‡§æ‡§è‡§ó‡•Ä ‡§á‡§∏ ‡§≠‡§Ø‡§æ‡§®‡§ï ‡§∞‡§π‡§∏‡•ç‡§Ø ‡§∏‡•á?",
  //   youtube_thumbnails: [
  //     "The girl's face contorted in terror as a shadowy hand reaches for her.",
  //     "A close-up of the ancient book's disturbing illustrations, with an eerie glow.",
  //     "The reflection of a shadowy figure in the black, still waters of the Kali River.",
  //   ],
  //   image_tags: [
  //     "A close-up of a cracked, ancient book with unsettling illustrations, held in trembling hands.",
  //     "A young girl, silhouetted against the moonlit ruins of a temple, looking terrified.",
  //     "The dilapidated temple at night, shrouded in mist, with an eerie glow emanating from within.",
  //     "A wide shot of a village nestled beside a dark, ominous river.",
  //     "Close-up on the eyes of an old man, vacant and filled with a haunting emptiness.",
  //     "Reflective, black water of the Kali River, with strange whispers seeming to rise from its depths.",
  //     "A crumbling stone statue within the temple ruins, partially obscured by shadows.",
  //     "The girl discovering a hidden chamber within the ruins, with a sense of impending dread.",
  //     "A shadowy figure lurking in the background, its presence barely perceptible.",
  //     "A hand reaching out from the darkness, grasping at the girl's arm.",
  //   ],
  //   description:
  //     "‡§è‡§ï ‡§ñ‡§Ç‡§°‡§π‡§∞ ‡§Æ‡•á‡§Ç ‡§¶‡§¨‡•á ‡§™‡•ç‡§∞‡§æ‡§ö‡•Ä‡§® ‡§∂‡•ç‡§∞‡§æ‡§™ ‡§ï‡•Ä ‡§ï‡§π‡§æ‡§®‡•Ä... ‡§Ø‡§æ‡§¶‡§¶‡§æ‡§∂‡•ç‡§§ ‡§ö‡•Å‡§∞‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§õ‡§æ‡§Ø‡§æ ‡§ï‡§æ ‡§∏‡§æ‡§Ø‡§æ... ‡§ï‡•ç‡§Ø‡§æ ‡§∏‡•Ä‡§§‡§æ ‡§¨‡§ö ‡§™‡§æ‡§è‡§ó‡•Ä ‡§á‡§∏ ‡§≠‡§Ø‡§æ‡§®‡§ï ‡§∞‡§π‡§∏‡•ç‡§Ø ‡§∏‡•á?",
  //   youtube_thumbnails: [
  //     "The girl's face contorted in terror as a shadowy hand reaches for her.",
  //     "A close-up of the ancient book's disturbing illustrations, with an eerie glow.",
  //     "The reflection of a shadowy figure in the black, still waters of the Kali River.",
  //   ],
  // };
  const title = extractTitle(aiOutput.title);
  const safeTitle = sanitizeFilename(aiOutput.title);
  const storyUtilsPrompt = await promptStoryUtils(...Object.values(aiOutput));
  const dynamicPromptsStoryUtils = `${storyUtilsPrompt}\n\n// Generate story seed: ${Date.now()}`;

  await sleep(2000 + Math.random() * 3000); // 2‚Äì5 sec delay

  const responseUtils = await gen.generateContent(
    dynamicPromptsStoryUtils.trim()
  );

  const rawUtilsOut = await extractJSONBlock(responseUtils.response.text());
  const aiOutputUtils = JSON.parse(rawUtilsOut);
  console.log("AI Output P2:", aiOutputUtils);

  const StoryData = {
    title,
    ...aiOutput,
    ...aiOutputUtils,
  };
  console.log("StoryData", StoryData);

  await generateFolderFile(`stories/${safeTitle}`, "story", StoryData);

  console.log("‚úÖ Story generated:", { title, ...aiOutput, ...aiOutputUtils });

  return StoryData;
}

// ----------------------- Helper Functions -----------------------

function extractTitle(story) {
  const lines = story.split("\n").filter(Boolean);
  return lines[0].length < 100 ? lines[0] : "AI_Story";
}

function sanitizeFilename(name) {
  return name
    .replace(/[<>:"/\\|?*\x00-\x1F]/g, "")
    .replace(/\s+/g, "_")
    .substring(0, 50);
}

function extractJSONBlock(text) {
  const match = text.match(/```json\s*([\s\S]*?)\s*```/);
  if (match) {
    return match[1].trim();
  }

  // fallback: try to parse the first valid JSON-like object
  const start = text.indexOf("{");
  const end = text.lastIndexOf("}");
  if (start !== -1 && end !== -1 && end > start) {
    return text.slice(start, end + 1).trim();
  }

  throw new Error("‚ùå No valid JSON block found in text");
}
