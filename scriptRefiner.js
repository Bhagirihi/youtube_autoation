import {
  cleanAndParagraph,
  readFileUtf8,
  saveToFile,
  sleep,
} from "./helper/globalHelpers.js";
import { GoogleGenerativeAI } from "@google/generative-ai";
import path from "path";
import dotenv from "dotenv";
import axios from "axios";
import fs from "fs-extra";
import { updateExcel } from "./helper/excelHelpers.js";

dotenv.config();

// Get message from parent
process.on("message", async ({ label, row }) => {
  const { slug } = JSON.parse(row);
  console.log(`ЁЯОЩя╕П ${label} Received row for: ${slug}`);
  const filePath = path.join("storyScript", `${slug}_summary.txt`);
  const summary = await readFileUtf8(filePath);
  console.log(`ЁЯОЩя╕П [${label}] summary length =`, summary.length);
  if (summary.length > 0) {
    const storyFromSummary = await generateStoryFromSummary(slug, summary);
    console.log(
      `ЁЯОЩя╕П [${label}] Story Generated From Summary..., ${JSON.stringify(
        storyFromSummary
      )}`
    );
  } else {
    console.log(`ЁЯОЩя╕П [${label}] summary is empty, skipping...`);
    process.send?.({ status: "skipped", title: row.title });
    process.exit(0);
  }

  // Simulate work
  await new Promise((res) => setTimeout(res, 1000));
  process.send?.({ status: "done", title: row.title });
  process.exit(0);
});

function extractJson(raw = "") {
  const match = raw.match(/```(?:json)?\s*([\s\S]*?)\s*```/i);
  const jsonLike = (match ? match[1] : raw).trim();

  // Fix: convert single quotes тЖТ double quotes, quote keys
  const fixed = jsonLike
    .replace(/([{,]\s*)(\w+)\s*:/g, '$1"$2":') // quote keys
    .replace(/'([^']*)'/g, (_, s) => `"${s.replace(/"/g, '\\"')}"`); // convert '...' to "..."

  return fixed;
}

async function getMetaData(raw = "") {
  const result = {
    title: null,
    story: null,
    youtube_tags: [],
    image_tags: [],
  };

  // 1я╕ПтГг Strict JSON.parse
  try {
    const obj = JSON.parse(raw);
    if (obj.title) result.title = obj.title;
    if (obj.story) result.story = obj.story;
    if (Array.isArray(obj.youtube_tags)) result.youtube_tags = obj.youtube_tags;
    if (Array.isArray(obj.image_tags)) result.image_tags = obj.image_tags;
    return result;
  } catch {
    /* ignore */
  }

  // 2я╕ПтГг Loose Fallbacks with Regex

  // title
  const titleMatch = raw.match(/"title"\s*:\s*"([^"]+?)"/i);
  if (titleMatch) result.title = titleMatch[1].trim();

  // story
  const storyMatch = raw.match(/"story"\s*:\s*"([\s\S]*?)"\s*(,|\})/i);
  if (storyMatch) {
    result.story = storyMatch[1]
      .replace(/\\"/g, '"') // unescape quotes
      .replace(/\\n/g, "\n") // unescape line breaks
      .trim();
  }

  // youtube_tags
  const ytTagsMatch = raw.match(/"youtube_tags"\s*:\s*\[([^\]]+)\]/i);
  if (ytTagsMatch) {
    result.youtube_tags = ytTagsMatch[1]
      .split(",")
      .map((tag) => tag.trim().replace(/^"|"$/g, ""))
      .filter(Boolean);
  }

  // image_tags
  const imgTagsMatch = raw.match(/"image_tags"\s*:\s*\[([^\]]+)\]/i);
  if (imgTagsMatch) {
    result.image_tags = imgTagsMatch[1]
      .split(",")
      .map((tag) => tag.trim().replace(/^"|"$/g, ""))
      .filter(Boolean);
  }

  return result;
}

function cleanArrayString(input = "") {
  return input
    .replace(/^\[|\]$/g, "") // remove [ and ]
    .replace(/,\s*$/, "") // remove trailing comma
    .trim();
}

async function downloadImage(url, filename) {
  const downloadFolder = path.resolve("storyScript_AI/images");
  await fs.ensureDir(downloadFolder);
  const filePath = path.join(downloadFolder, filename);
  const writer = fs.createWriteStream(filePath);

  const response = await axios({
    url,
    method: "GET",
    responseType: "stream",
  });

  response.data.pipe(writer);
  return new Promise((resolve, reject) => {
    writer.on("finish", () => resolve(filePath));
    writer.on("error", reject);
  });
}

async function fetchAndDownloadImages(tags) {
  const results = [];
  const UNSPLASH_KEY = process.env.UNSPLASH_API_KEY;

  if (!UNSPLASH_KEY) throw new Error("UNSPLASH_API_KEY missing");
  for (const tag of tags) {
    const searchQuery = `${tag} horror story`;

    try {
      const res = await axios.get("https://api.unsplash.com/search/photos", {
        params: {
          query: searchQuery,
          per_page: 1,
          orientation: "landscape",
          content_filter: "high",
        },
        headers: {
          Authorization: `Client-ID ${ACCESS_KEY}`,
        },
      });

      const photo = res.data.results?.[0];
      if (photo) {
        const imageUrl = photo.urls.full;
        const filename = `${tag.replace(/\s+/g, "_")}.jpg`;

        const savedPath = await downloadImage(imageUrl, filename);

        results.push({
          tag,
          query: searchQuery,
          image_url: imageUrl,
          saved_as: filename,
          local_path: savedPath,
          photographer: photo.user.name,
          source_link: photo.links.html,
        });

        console.log(`тЬЕ Downloaded: ${filename}`);
      } else {
        results.push({ tag, query: searchQuery, error: "No image found" });
        console.log(`тЪая╕П No result for: ${tag}`);
      }
    } catch (err) {
      console.error(`тЭМ Error for "${tag}":`, err.message);
      results.push({ tag, query: searchQuery, error: err.message });
    }
  }
  // Save metadata to storyScript_AI/unsplash_horror_images.json
  const metadataPath = path.join(
    "storyScript_AI",
    "unsplash_horror_images.json"
  );
  await fs.ensureDir(path.dirname(metadataPath));
  fs.writeFileSync(metadataPath, JSON.stringify(results, null, 2));
  console.log("ЁЯУБ Metadata saved:", metadataPath);
}

const generatePrompt = (summary) => `
рдЖрдк рдПрдХ рдкреЗрд╢реЗрд╡рд░ рд╣рд┐рдВрджреА рд╣реЙрд░рд░ рдХрд╣рд╛рдиреА рд▓реЗрдЦрдХ рдФрд░ рд╡реЙрдЗрд╕рдУрд╡рд░ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд░рд╛рдЗрдЯрд░ рд╣реИрдВред

рдЖрдкрдХреЛ рдиреАрдЪреЗ рджреА рдЧрдИ рдЗрдВрдЧреНрд▓рд┐рд╢ рд╕рдорд░реА рдХреЛ рдПрдХ рдЖрдХрд░реНрд╖рдХ, рднрд╛рд╡рдирд╛рддреНрдордХ рдФрд░ рдбрд░рд╛рд╡рдиреА **рд╣рд┐рдВрджреА рдХрд╣рд╛рдиреА** рдореЗрдВ рдмрджрд▓рдиреА рд╣реИ, рдЬреЛ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╡реЙрдЗрд╕рдУрд╡рд░ рдФрд░ рдЯреЗрдХреНрд╕реНрдЯ-рдЯреВ-рд╕реНрдкреАрдЪ (TTS) рдХреЗ рд▓рд┐рдП рдЕрдиреБрдХреВрд▓ рд╣реЛред

**рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ:**
1. рдХрд╣рд╛рдиреА рдореЗрдВ **рдбрд░, рд░рд╣рд╕реНрдп рдФрд░ рдорд╛рдирд╡реАрдп рднрд╛рд╡рдирд╛рдУрдВ рдХрд╛ рд╕рдВрддреБрд▓рди** рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред
2. рд╡рд╛рдХреНрдпреЛрдВ рдХреА рд▓рдВрдмрд╛рдИ рдордзреНрдпрдо рд░рдЦреЗрдВ рддрд╛рдХрд┐ **TTS рд╕реНрд╡рд╛рднрд╛рд╡рд┐рдХ рд░реВрдк рд╕реЗ рдкрдврд╝ рд╕рдХреЗред**
3. рдЬрд╣рд╛рдВ рдЬрд╝рд░реВрд░реА рд╣реЛ, рд╡рд╣рд╛рдВ **рд╕реНрд╡рд╛рднрд╛рд╡рд┐рдХ рд╡рд┐рд░рд╛рдо (рдЬреИрд╕реЗ тАШ...тАЩ рдпрд╛ 'тАФ')** рдЬреЛрдбрд╝реЗрдВред
4. рдХрд╣рд╛рдиреА рдХрд╛ рдЯреЛрди рд╕рд╕реНрдкреЗрдВрд╕рдлреБрд▓ рдФрд░ рдЗрдореЛрд╢рдирд▓ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред
5. TTS рдХреЗ рд▓рд┐рдП рдЖрд╕рд╛рди рд╢рдмреНрджреЛрдВ рдХрд╛ рдкреНрд░рдпреЛрдЧ рдХрд░реЗрдВред
6. рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдРрд╕реЗ рд▓рд┐рдЦреЗрдВ рдЬреИрд╕реЗ рдпреВрдЯреНрдпреВрдм рдСрдбрд┐рдпреЛ рдбреНрд░рд╛рдорд╛ рдореЗрдВ рд╕реБрдирд╛рдИ рдЬрд╛рддреА рд╣реИред
7. рдЖрдЙрдЯрдкреБрдЯ **рд╕рд┐рд░реНрдлрд╝ рдирд┐рдореНрди JSON рдСрдмреНрдЬреЗрдХреНрдЯ рджреЗрдВ** тАФ
   рдХреЛрдИ рдХреЛрдбтАСрдмреНрд▓реЙрдХ, рдЕрддрд┐рд░рд┐рдХреНрдд рдЯреЗрдХреНрд╕реНрдЯ, рдпрд╛ рд▓рд╛рдЗрдитАСрдмреНрд░реЗрдХ рди рд╣реЛред
   **рдзреНрдпрд╛рди рд░рдЦреЗрдВ:**
   тАв рд╣рд░ key рдФрд░ value рдбрдмрд▓тАСрдХреНрд╡реЛрдЯ рдореЗрдВ рд╣реЛред
   тАв рдпрджрд┐ value рдХреЗ рдЕрдВрджрд░ рдбрдмрд▓тАСрдХреНрд╡реЛрдЯ рдХреА рдЬрд╝рд░реВрд░рдд рдкрдбрд╝реЗ рддреЛ рдЙрд╕реЗ \\" рдЗрд╕ рдкреНрд░рдХрд╛рд░ escape рдХрд░реЗрдВред
   тАв рдХреЛрдИ trailing comma рди рдЫреЛрдбрд╝реЗрдВред
{
"title": "<1 рдЖрдХрд░реНрд╖рдХ рд╣рд┐рдВрджреА рд╢реАрд░реНрд╖рдХ (тЙдтАп8 рд╢рдмреНрдж)>",
 "image_tags": [<AI рдЗрдореЗрдЬ рдЯреВрд▓ рдХреЗ рд▓рд┐рдП English рд╡рд┐рдЬрд╝реБрдЕрд▓ рдЯреИрдЧреНрд╕>],
"youtube_tags": ["<SEO-рдЕрдиреБрдХреВрд▓ рдпреВрдЯреНрдпреВрдм рдЯреИрдЧреНрд╕, 8тАУ15>"],
"story": "<6000тАУ12000 рд╢рдмреНрджреЛрдВ рдХреА рд╕рд╕реНрдкреЗрдВрд╕рдлреБрд▓ рдФрд░ TTS рдХреЗ рдЕрдиреБрдХреВрд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯ>"
}

8. рдЕрдВрддрд┐рдо рдЖрдЙрдЯрдкреБрдЯ рдкреВрд░реНрдг рд░реВрдк рд╕реЗ рд╣рд┐рдВрджреА (UTFтАС8) рдореЗрдВ рд╣реЛ тАФ
   рдХрд╣рд╛рдиреА рдРрд╕реА рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП рдЬрд┐рд╕реЗ рдкреЗрд╢реЗрд╡рд░ рдХрдерд╛рд╡рд╛рдЪрдХ **рд╕реАрдзрд╛ рдкрдврд╝ рд╕рдХреЗ**, рдХрд┐рд╕реА рдФрд░ рд╕рдВрдкрд╛рджрди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рди рдкрдбрд╝реЗред

---

**ЁЯФ╜ рдЗрдВрдЧреНрд▓рд┐рд╢ рд╕рдорд░реА:**

${summary.trim()}
`;

async function generateStoryFromSummary(slug, summary) {
  const GEMINI_KEY = process.env.GEMINI_API_KEY;

  if (!GEMINI_KEY) throw new Error("GEMINI_API_KEY missing");
  const promptText = generatePrompt(summary);
  console.log(`ЁЯОЩя╕П [${slug}] ${promptText.trim()}`);
  const gen = new GoogleGenerativeAI(GEMINI_KEY).getGenerativeModel({
    model: "gemini-2.0-flash",
  });
  await sleep(2000 + Math.random() * 3000); // 2000тАС5000тАпms
  const { response } = await gen.generateContent(promptText.trim());
  console.log("response", response);
  const rawOut = await response.text();
  const aiOutput = extractJson(rawOut);
  console.log("aiOutput", aiOutput);
  // const aiOutput = {
  //   title: "рдХрд┐рд░рд╛рдпреЗ рдХрд╛ рдордХрд╛рди: рд░реВрд╣реЛрдВ рдХрд╛ рдмрд╕реЗрд░рд╛",
  //   image_tags: [
  //     "haunted house",
  //     "dark room",
  //     "ghostly figure",
  //     "eerie atmosphere",
  //     "old furniture",
  //     "Rajasthan village",
  //     "night scene",
  //     "paranormal activity",
  //     "family scared",
  //     "Indian horror",
  //   ],
  //   youtube_tags: [
  //     "рдХрд┐рд░рд╛рдпреЗ рдХрд╛ рдордХрд╛рди",
  //     "рд╣рд┐рдВрджреА рд╣реЙрд░рд░ рд╕реНрдЯреЛрд░реА",
  //     "рднреВрддрд┐рдпрд╛ рдХрд╣рд╛рдиреА",
  //     "рдбрд░рд╛рд╡рдиреА рдХрд╣рд╛рдиреА",
  //     "рд╕рдЪреНрдЪреА рдХрд╣рд╛рдиреА",
  //     "рд╣реЙрд░рд░ рд╕реНрдЯреЛрд░реА",
  //     "рднреВрдд рдкреНрд░реЗрдд",
  //     "рд░рд╛рдЬрд╕реНрдерд╛рди рд╣реЙрд░рд░",
  //     "рдкреИрд░рд╛рдиреЙрд░реНрдорд▓ рдПрдХреНрдЯрд┐рд╡рд┐рдЯреА",
  //     "рдбрд░рд╛рд╡рдиреА рд░рд╛рдд",
  //     "рднреВрддрд┐рдпрд╛ рдШрд░",
  //     "рд╣рд┐рдВрджреА рдСрдбрд┐рдпреЛ рдбреНрд░рд╛рдорд╛",
  //     "рд╣реЙрд░рд░ рд╕реНрдЯреЛрд░реАрдЬ рдЗрди рд╣рд┐рдВрджреА",
  //     "рд╣рд┐рдВрджреА рднреВрддрд┐рдпрд╛ рдХрд╣рд╛рдирд┐рдпрд╛рдБ",
  //     "рдбрд░рд╛рд╡рдиреА рдХрд╣рд╛рдирд┐рдпрд╛рдБ",
  //   ],
  //   story:
  //     "рдирдорд╕реНрдХрд╛рд░ рджреЛрд╕реНрддреЛрдВ, рдореИрдВ рд╣реВрдБ рдорд╣реЗрд╢, рдФрд░ рдЖрдЬ рд╣рдо рдмрд╛рдд рдХрд░реЗрдВрдЧреЗ рдХрд┐рд░рд╛рдП рдХреЗ рдордХрд╛рдиреЛрдВ рд╕реЗ рдЬреБрдбрд╝реА рдХреБрдЫ рдРрд╕реА рдбрд░рд╛рд╡рдиреА рдХрд╣рд╛рдирд┐рдпреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ, рдЬреЛ рдЖрдкрдХреЗ рд░реЛрдВрдЧрдЯреЗ рдЦрдбрд╝реЗ рдХрд░ рджреЗрдВрдЧреАред рдЕрдЧрд░ рдЖрдкрдХреЗ рдкрд╛рд╕ рднреА рдХреЛрдИ рдРрд╕реА рдХрд╣рд╛рдиреА рд╣реИ, рддреЛ рдЬрд╝рд░реВрд░ рдмрддрд╛рдЗрдПрдЧрд╛, рд╢рд╛рдпрдж рдЕрдЧрд▓реА рдмрд╛рд░ рдЖрдкрдХреА рдХрд╣рд╛рдиреА рдореИрдВ рд╕реБрдирд╛рдКрдБ...\n\nрдЖрдЬ рдХреА рдХрд╣рд╛рдиреА рдореЗрд░реЗ рдЕрдкрдиреЗ рдмрдЪрдкрди рдХреА рд╣реИ... рдмрд╛рдд рддрдм рдХреА рд╣реИ рдЬрдм рд╣рдо рдЬреЛрдзрдкреБрд░ рд╕реЗ рдЖрдмреВ рд░реЛрдб, рд░рд╛рдЬрд╕реНрдерд╛рди, рд░рд╣рдиреЗ рдЧрдП рдереЗред рдореЗрд░реЗ рдкрд┐рддрд╛рдЬреА рдХрд╛ рддрдмрд╛рджрд▓рд╛ рд╣реБрдЖ рдерд╛, рдФрд░ рд╣рдореЗрдВ рдПрдХ рдирдпрд╛ рдШрд░ рдвреВрдВрдврдирд╛ рдерд╛... рдЖрдЦрд╝рд┐рд░рдХрд╛рд░, рд╣рдореЗрдВ рдПрдХ рдХрд┐рд░рд╛рдП рдХрд╛ рдордХрд╛рди рдорд┐рд▓ рдЧрдпрд╛ред рдордХрд╛рди рдмрдбрд╝рд╛ рддреЛ рдерд╛, рд▓реЗрдХрд┐рди рдЙрд╕рдореЗрдВ рдПрдХ рдЕрдЬреАрдм рд╕реА рд╢рд╛рдВрддрд┐ рдереА... рдПрдХ рдРрд╕реА рд╢рд╛рдВрддрд┐ рдЬреЛ рдбрд░рд╛рд╡рдиреА рдереАред\n\nрдордХрд╛рди рдЖрдмреВ рд░реЛрдб рдХреЗ рдмрд╛рд╣рд░реА рдЗрд▓рд╛рдХреЗ рдореЗрдВ рдерд╛ред рдЖрд╕-рдкрдбрд╝реЛрд╕ рдореЗрдВ рдХреБрдЫ рдШрд░ рдереЗ, рд▓реЗрдХрд┐рди рдЬрд╝реНрдпрд╛рджрд╛ рдЪрд╣рд▓-рдкрд╣рд▓ рдирд╣реАрдВ рдереАред рдореБрдЭреЗ рдпрд╛рдж рд╣реИ, рдЬрдм рд╣рдо рдкрд╣рд▓реА рдмрд╛рд░ рдЙрд╕ рдШрд░ рдореЗрдВ рдЖрдП, рддреЛ рдореБрдЭреЗ рдЕрдЬреАрдм рд▓рдЧрдиреЗ рд▓рдЧрд╛ рдерд╛... рдЬреИрд╕реЗ рдХреЛрдИ рдореБрдЭреЗ рдШреВрд░ рд░рд╣рд╛ рд╣реЛред\n\nрд╣рдорд╛рд░реЗ рдкрдбрд╝реЛрд╕реА рднреА рдереЛрдбрд╝реЗ рдЕрдЬреАрдм рдереЗред рдПрдХ рд▓рдбрд╝рдХрд╛ рдерд╛, рдЬрд┐рд╕рдХреА рдЖрдБрдЦреЗрдВ... рдЙрд╕рдХреА рдЖрдБрдЦреЛрдВ рдореЗрдВ рдХреБрдЫ рддреЛ рдЕрдЬреАрдм рдерд╛ред рдФрд░ рдЙрд╕рдХреА рдорд╛рдБ... рд╡реЛ рд╣рдореЗрд╢рд╛ рдЕрдЬреАрдм рд╕рд╡рд╛рд▓ рдкреВрдЫрддреА рдереАред рдЬреИрд╕реЗ, тАЬрддреБрдо рд▓реЛрдЧ рдХрдм рд╕реЗ рдпрд╣рд╛рдБ рд░рд╣рдиреЗ рдЖрдП рд╣реЛ?тАЭ рдпрд╛ тАЬрддреБрдореНрд╣рд╛рд░реЗ рдШрд░ рдореЗрдВ рдХрд┐рддрдиреЗ рд▓реЛрдЧ рд╣реИрдВ?тАЭ... рдЙрдирдХреА рдмрд╛рддреЗрдВ рд╕реБрдирдХрд░ рдореБрдЭреЗ рд╣рдореЗрд╢рд╛ рдбрд░ рд▓рдЧрддрд╛ рдерд╛ред\n\nрд╢реБрд░реВ рдореЗрдВ рддреЛ рд╕рдм рдареАрдХ рдерд╛, рд▓реЗрдХрд┐рди рдлрд┐рд░ рдЕрдЬреАрдм-рдЕрдЬреАрдм рдЪреАрдЬреЗрдВ рд╣реЛрдиреЗ рд▓рдЧреАрдВ... рд░рд╛рдд рдореЗрдВ рдЧреИрд╕ рд▓реАрдХ рд╣реЛрдиреЗ рд▓рдЧрддреА... рд▓рд╛рдЗрдЯреЗрдВ рдЕрдкрдиреЗ рдЖрдк рдЬрд▓рддреА-рдмреБрдЭрддреА рд░рд╣рддреАрдВ... рдФрд░ рдХрднреА-рдХрднреА рддреЛ рдРрд╕рд╛ рд▓рдЧрддрд╛ рдерд╛ рдЬреИрд╕реЗ рдХреЛрдИ рдШрд░ рдореЗрдВ рдШреВрдо рд░рд╣рд╛ рд╣реИ...\n\nрдореЗрд░рд╛ рдЫреЛрдЯрд╛ рднрд╛рдИ, рд░рд╡рд┐, рдЕрдЬреАрдм рд╣рд░рдХрддреЗрдВ рдХрд░рдиреЗ рд▓рдЧрд╛ рдерд╛... рд╡реЛ рдХрд╣рддрд╛ рдерд╛ рдХрд┐ рдЙрд╕реЗ рдкрд┐рддрд╛рдЬреА рджрд┐рдЦ рд░рд╣реЗ рд╣реИрдВ, рдЬрдмрдХрд┐ рдкрд┐рддрд╛рдЬреА рдШрд░ рдкрд░ рдирд╣реАрдВ рд╣реЛрддреЗ рдереЗред рдПрдХ рджрд┐рди, рдЙрд╕рдиреЗ рдореБрдЭрд╕реЗ рдХрд╣рд╛, тАЬрднреИрдпрд╛, рдкрд┐рддрд╛рдЬреА рдореБрдЭреЗ рдмреБрд▓рд╛ рд░рд╣реЗ рд╣реИрдВтАжтАЭ рдореИрдВрдиреЗ рдЙрд╕реЗ рдмрд╣реБрдд рд╕рдордЭрд╛рдпрд╛ рдХрд┐ рдкрд┐рддрд╛рдЬреА рддреЛ рдСрдлрд┐рд╕ рдЧрдП рд╣реИрдВ, рд▓реЗрдХрд┐рди рд╡реЛ рдорд╛рдирдиреЗ рдХреЛ рддреИрдпрд╛рд░ рд╣реА рдирд╣реАрдВ рдерд╛...\n\nрдПрдХ рд░рд╛рдд, рдореИрдВ рдкрдврд╝ рд░рд╣рд╛ рдерд╛... рддрднреА рдореБрдЭреЗ рдХреБрдЫ рдЖрд╡рд╛рдЬрд╝реЗрдВ рд╕реБрдирд╛рдИ рджреАрдВ... рдЬреИрд╕реЗ рдХреЛрдИ рдлреБрд╕рдлреБрд╕рд╛ рд░рд╣рд╛ рд╣реЛ... рдореИрдВрдиреЗ рдзреНрдпрд╛рди рд╕реЗ рд╕реБрдирд╛ рддреЛ рдЖрд╡рд╛рдЬрд╝реЗрдВ рдФрд░ рддреЗрдЬрд╝ рд╣реЛ рдЧрдИрдВ... рдореИрдВ рдбрд░ рдЧрдпрд╛... рдореИрдВрдиреЗ рдХрдорд░реЗ рд╕реЗ рдмрд╛рд╣рд░ рдЭрд╛рдБрдХрд╛, рд▓реЗрдХрд┐рди рдореБрдЭреЗ рдХреЛрдИ рдирд╣реАрдВ рджрд┐рдЦрд╛ред\n\nрдЕрдЧрд▓реА рд░рд╛рдд, рдореИрдВрдиреЗ рджреЗрдЦрд╛ рдХрд┐ рдХрдорд░реЗ рдореЗрдВ рд░рдЦреА рдЪреАрдЬреЗрдВ рдЕрдкрдиреЗ рдЖрдк рд╣рд┐рд▓ рд░рд╣реА рд╣реИрдВ... рдПрдХ рдХреБрд░реНрд╕реА рдЕрдкрдиреЗ рдЖрдк рд╕рд░рдХ рд░рд╣реА рдереА... рдПрдХ рдХрд┐рддрд╛рдм рдЕрдкрдиреЗ рдЖрдк рдЦреБрд▓реА рдФрд░ рдмрдВрдж рд╣реЛ рд░рд╣реА рдереА... рдореИрдВ рдбрд░ рдХреЗ рдорд╛рд░реЗ рдХрд╛рдБрдкрдиреЗ рд▓рдЧрд╛ред\n\nрдзреАрд░реЗ-рдзреАрд░реЗ, рдШрд░ рдХрд╛ рдорд╛рд╣реМрд▓ рдФрд░ рднреА рдбрд░рд╛рд╡рдирд╛ рд╣реЛрддрд╛ рдЧрдпрд╛... рд╣рд░ рд╡рдХрд╝реНрдд рдРрд╕рд╛ рд▓рдЧрддрд╛ рдерд╛ рдЬреИрд╕реЗ рдХреЛрдИ рд╣рдорд╛рд░реЗ рдЖрд╕рдкрд╛рд╕ рд╣реИ... рдЬреИрд╕реЗ рдХреЛрдИ рд╣рдореЗрдВ рджреЗрдЦ рд░рд╣рд╛ рд╣реИ... рдШрд░ рдореЗрдВ рдПрдХ рдЕрдЬреАрдм рд╕реА рдмрджрдмреВ рдЖрдиреЗ рд▓рдЧреА рдереА... рдПрдХ рдРрд╕реА рдмрджрдмреВ рдЬреЛ рдореБрдЭреЗ рдпрд╛рдж рдирд╣реАрдВ рдХрд┐ рдореИрдВрдиреЗ рдкрд╣рд▓реЗ рдХрднреА рдорд╣рд╕реВрд╕ рдХреА рд╣реЛ... рд╕рдбрд╝реА рд╣реБрдИ, рдФрд░ рдХреБрдЫ рдЕрдЬреАрдм... рдЬреИрд╕реЗ рдХреЛрдИ рд▓рд╛рд╢ рд╕рдбрд╝ рд░рд╣реА рд╣реЛред\n\nрдПрдХ рджрд┐рди, рдореИрдВрдиреЗ рдЕрдкрдиреА рдорд╛рдБ рд╕реЗ рдХрд╣рд╛, тАЬрдорд╛рдБ, рдореБрдЭреЗ рдЗрд╕ рдШрд░ рдореЗрдВ рдбрд░ рд▓рдЧрддрд╛ рд╣реИтАжтАЭ рдорд╛рдБ рдиреЗ рдХрд╣рд╛, тАЬрдореБрдЭреЗ рднреА рд▓рдЧрддрд╛ рд╣реИ рдмреЗрдЯрд╛, рд▓реЗрдХрд┐рди рд╣рдо рдХреНрдпрд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ? рдкрд┐рддрд╛рдЬреА рдХрд╛ рдЯреНрд░рд╛рдВрд╕рдлрд░ рд╣реЛ рдЧрдпрд╛ рд╣реИ, рдФрд░ рд╣рдореЗрдВ рдпрд╣реАрдВ рд░рд╣рдирд╛ рд╣реЛрдЧрд╛тАжтАЭ\n\nрдлрд┐рд░ рдПрдХ рджрд┐рди, рдкрд┐рддрд╛рдЬреА рдХреЛ рдкрдбрд╝реЛрд╕ рдХреЗ рдПрдХ рдЖрджрдореА рдиреЗ рдмрддрд╛рдпрд╛ рдХрд┐ рдЗрд╕ рдШрд░ рдореЗрдВ рдкрд╣рд▓реЗ рдХреБрдЫ рд▓реЛрдЧ рд░рд╣рддреЗ рдереЗ, рдЬрд┐рдирдХреА рдореМрдд рд╣реЛ рдЧрдИ рдереА... рдЙрд╕рдиреЗ рдмрддрд╛рдпрд╛ рдХрд┐ рдЗрд╕ рдШрд░ рдореЗрдВ рдХреБрдЫ рдЖрддреНрдорд╛рдПрдБ рд╣реИрдВ, рдЬреЛ рдпрд╣рд╛рдБ рд╕реЗ рдЬрд╛рдирд╛ рдирд╣реАрдВ рдЪрд╛рд╣рддреАрдВ...\n\nрдпрд╣ рд╕реБрдирдХрд░ рдкрд┐рддрд╛рдЬреА рдбрд░ рдЧрдП... рдЙрдиреНрд╣реЛрдВрдиреЗ рддреБрд░рдВрдд рдПрдХ рдкрдВрдбрд┐рдд рдЬреА рдХреЛ рдмреБрд▓рд╛рдпрд╛ред рдкрдВрдбрд┐рдд рдЬреА рдиреЗ рдШрд░ рдореЗрдВ рдкреВрдЬрд╛ рдХреА, рд▓реЗрдХрд┐рди рдХреБрдЫ рдлрд╝рд╛рдпрджрд╛ рдирд╣реАрдВ рд╣реБрдЖ... рдбрд░рд╛рд╡рдиреА рдЪреАрдЬреЗрдВ рд╣реЛрддреА рд░рд╣реАрдВ...\n\nрдЖрдЦрд┐рд░рдХрд╛рд░, рдкрд┐рддрд╛рдЬреА рдиреЗ рдПрдХ рддрд╛рдВрддреНрд░рд┐рдХ рдХреЛ рдмреБрд▓рд╛рдпрд╛... рддрд╛рдВрддреНрд░рд┐рдХ рдиреЗ рдШрд░ рдореЗрдВ рдЖрдХрд░ рджреЗрдЦрд╛ рдФрд░ рдХрд╣рд╛, тАЬрдпрд╣ рдШрд░ рд╢рд╛рдкрд┐рдд рд╣реИ... рдпрд╣рд╛рдБ рдкрд░ 82 рд▓реЛрдЧреЛрдВ рдХреА рдЖрддреНрдорд╛рдПрдБ рднрдЯрдХ рд░рд╣реА рд╣реИрдВ... рдпреЗ рдЖрддреНрдорд╛рдПрдБ рдмрд╣реБрдд рд╢рдХреНрддрд┐рд╢рд╛рд▓реА рд╣реИрдВ, рдФрд░ рдЗрдиреНрд╣реЗрдВ рдпрд╣рд╛рдБ рд╕реЗ рдирд┐рдХрд╛рд▓рдирд╛ рдмрд╣реБрдд рдореБрд╢реНрдХрд┐рд▓ рд╣реИтАжтАЭ\n\nрддрд╛рдВрддреНрд░рд┐рдХ рдиреЗ рдмрддрд╛рдпрд╛ рдХрд┐ рдмрд╣реБрдд рд╕рдордп рдкрд╣рд▓реЗ, рд╕рд░рдХрд╛рд░ рдЗрд╕ рдЗрд▓рд╛рдХреЗ рдХреЛ рд╕рд╛рдлрд╝ рдХрд░рдирд╛ рдЪрд╛рд╣рддреА рдереА, рдФрд░ рдпрд╣рд╛рдБ рд░рд╣рдиреЗ рд╡рд╛рд▓реЗ рд▓реЛрдЧреЛрдВ рдХреЛ рдпрд╣рд╛рдБ рд╕реЗ рд╣рдЯрд╛рдирд╛ рдЪрд╛рд╣рддреА рдереА... рд▓реЗрдХрд┐рди рдЙрди рд▓реЛрдЧреЛрдВ рдиреЗ рдЬрд╝рдореАрди рдЫреЛрдбрд╝рдиреЗ рд╕реЗ рдЗрдирдХрд╛рд░ рдХрд░ рджрд┐рдпрд╛... рддрдм рд╕рд░рдХрд╛рд░ рдиреЗ рдЙрди рдкрд░ рд╣рдорд▓рд╛ рдХрд░ рджрд┐рдпрд╛, рдФрд░ рдЙрди рд╕рднреА рдХреЛ рдорд╛рд░ рдбрд╛рд▓рд╛... рдЙрди 82 рд▓реЛрдЧреЛрдВ рдХреА рдЖрддреНрдорд╛рдПрдБ рдЕрдм рддрдХ рдпрд╣рд╛рдБ рднрдЯрдХ рд░рд╣реА рд╣реИрдВред\n\nрддрд╛рдВрддреНрд░рд┐рдХ рдиреЗ рдкрд┐рддрд╛рдЬреА рдХреЛ рд╕рд▓рд╛рд╣ рджреА рдХрд┐ рд╣рдореЗрдВ рддреБрд░рдВрдд рдпрд╣ рдШрд░ рдЫреЛрдбрд╝ рджреЗрдирд╛ рдЪрд╛рд╣рд┐рдП... рдЙрд╕рдиреЗ рдХрд╣рд╛ рдХрд┐ рдЕрдЧрд░ рд╣рдо рдпрд╣рд╛рдБ рд░рд╣реЗ рддреЛ рд╣рдорд╛рд░реА рдЬрд╛рди рдХреЛ рдЦрддрд░рд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред рдкрд┐рддрд╛рдЬреА рдиреЗ рдмрд┐рдирд╛ рджреЗрд░ рдХрд┐рдП рдШрд░ рдЫреЛрдбрд╝рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛... рд╣рдордиреЗ рд░рд╛рдд рд╣реА рд░рд╛рдд рдореЗрдВ рд╕рд╛рд░рд╛ рд╕рд╛рдорд╛рди рдкреИрдХ рдХрд┐рдпрд╛ рдФрд░ рдЙрд╕ рдШрд░ рд╕реЗ рдирд┐рдХрд▓ рдЧрдПред\n\nрд╣рдордиреЗ рдЖрдмреВ рд░реЛрдб рдореЗрдВ рд╣реА рдПрдХ рджреВрд╕рд░рд╛ рдШрд░ рдХрд┐рд░рд╛рдП рдкрд░ рд▓рд┐рдпрд╛, рдФрд░ рд╡рд╣рд╛рдБ рд░рд╣рдиреЗ рд▓рдЧреЗ... рдЙрд╕ рдШрд░ рдореЗрдВ рд╣рдореЗрдВ рд╢рд╛рдВрддрд┐ рдорд┐рд▓реА... рдЙрд╕ рдШрд░ рдореЗрдВ рд╣рдореЗрдВ рдбрд░ рдирд╣реАрдВ рд▓рдЧрд╛ред рд▓реЗрдХрд┐рди рдЙрд╕ рдбрд░рд╛рд╡рдиреЗ рдШрд░ рдХреА рдпрд╛рджреЗрдВ рдЖрдЬ рднреА рдореЗрд░реЗ рджрд┐рд▓ рдореЗрдВ рддрд╛рдЬрд╝рд╛ рд╣реИрдВ... рдЖрдЬ рднреА рдореИрдВ рдЙрд╕ рдШрд░ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕реЛрдЪрдХрд░ рдбрд░ рдЬрд╛рддрд╛ рд╣реВрдБред\n\nрджреЛрд╕реНрддреЛрдВ, рдпрд╣ рдереА рдореЗрд░реА рдХрд╣рд╛рдиреА... рдПрдХ рдРрд╕реА рдХрд╣рд╛рдиреА рдЬреЛ рдореБрдЭреЗ рд╣рдореЗрд╢рд╛ рдпрд╛рдж рд░рд╣реЗрдЧреА... рдПрдХ рдРрд╕реА рдХрд╣рд╛рдиреА рдЬреЛ рдореБрдЭреЗ рдмрддрд╛рддреА рд╣реИ рдХрд┐ рджреБрдирд┐рдпрд╛ рдореЗрдВ рдХреБрдЫ рдРрд╕реА рдЪреАрдЬреЗрдВ рд╣реИрдВ, рдЬрд┐рдирдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╣рдо рдирд╣реАрдВ рдЬрд╛рдирддреЗ... рдХреБрдЫ рдРрд╕реА рдЬрдЧрд╣реЗрдВ рд╣реИрдВ, рдЬрд╣рд╛рдБ рдкрд░ рднреВрдд-рдкреНрд░реЗрдд рд░рд╣рддреЗ рд╣реИрдВ... рдФрд░ рд╣рдореЗрдВ рдЙрдирд╕реЗ рд╕рд╛рд╡рдзрд╛рди рд░рд╣рдирд╛ рдЪрд╛рд╣рд┐рдПред\n\nрдЕрдм рдореИрдВ рдЖрдкрдХреЛ рдХреБрдЫ рдФрд░ рдбрд░рд╛рд╡рдиреА рдХрд╣рд╛рдирд┐рдпрд╛рдБ рд╕реБрдирд╛рдКрдБрдЧрд╛, рдЬреЛ рд▓реЛрдЧреЛрдВ рдиреЗ рдореЗрд░реЗ рд╕рд╛рде рд╢реЗрдпрд░ рдХреА рд╣реИрдВ...\n\nрдЕрдорди рдирд╛рдо рдХреЗ рдПрдХ рд▓рдбрд╝рдХреЗ рдиреЗ рдореБрдЭреЗ рдПрдХ рдХрд╣рд╛рдиреА рдмрддрд╛рдИ... рдЙрд╕рдиреЗ рдХрд╣рд╛ рдХрд┐ рд╡рд╣ рдПрдХ рдмрд╛рд░ рдЕрд╕реНрдкрддрд╛рд▓ рдореЗрдВ рднрд░реНрддреА рдерд╛... рд░рд╛рдд рдореЗрдВ, рдЙрд╕реЗ рдЕрдЬреАрдм рд╕реА рдЖрд╡рд╛рдЬрд╝реЗрдВ рд╕реБрдирд╛рдИ рджреАрдВ... рдЙрд╕рдиреЗ рджреЗрдЦрд╛ рдХрд┐ рдПрдХ рдмрдЪреНрдЪрд╛ рдХреЙрд░рд┐рдбреЛрд░ рдореЗрдВ рднрд╛рдЧ рд░рд╣рд╛ рд╣реИ... рдЕрдорди рдбрд░ рдЧрдпрд╛, рдФрд░ рдЙрд╕рдиреЗ рдкреВрд░реА рд░рд╛рдд рдбрд░ рдХреЗ рдорд╛рд░реЗ рдХрд╛рдЯреАред\n\nрдПрдХ рдФрд░ рдХрд╣рд╛рдиреА рд░рд╡реАрдирд╛ рдиреЗ рд╕реБрдирд╛рдИ... рд░рд╡реАрдирд╛ рдиреЗ рдмрддрд╛рдпрд╛ рдХрд┐ рдЙрд╕рдХреА рднрд╛рднреА рдЬрдм рдЧрд░реНрднрд╡рддреА рдереАрдВ, рддреЛ рдЙрдирдХреЗ рд╕рд╛рде рдЕрдЬреАрдм рдЪреАрдЬреЗрдВ рд╣реЛрдиреЗ рд▓рдЧреАрдВ... рдЙрдиреНрд╣реЗрдВ рд░рд╛рдд рдореЗрдВ рдбрд░рд╛рд╡рдиреЗ рд╕рдкрдиреЗ рдЖрддреЗ рдереЗ... рдЙрдиреНрд╣реЗрдВ рд▓рдЧрддрд╛ рдерд╛ рдЬреИрд╕реЗ рдХреЛрдИ рдЙрдиреНрд╣реЗрдВ рдорд╛рд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реИ... рд░рд╡реАрдирд╛ рдХрд╛ рдкрд░рд┐рд╡рд╛рд░ рдмрд╣реБрдд рдкрд░реЗрд╢рд╛рди рд╣реЛ рдЧрдпрд╛ рдерд╛ред\n\nрд╕рд▓рдорд╛ рдирд╛рдо рдХреА рдПрдХ рд▓рдбрд╝рдХреА рдиреЗ рдореБрдЭреЗ рдПрдХ рдХрд╣рд╛рдиреА рд╕реБрдирд╛рдИ... рд╕рд▓рдорд╛ рдиреЗ рдмрддрд╛рдпрд╛ рдХрд┐ рдЙрд╕рдХреА рдЪрд╛рдЪреА рдмрдЪрдкрди рдореЗрдВ рдПрдХ рдЬрд┐рдиреНрди рд╕реЗ рджреЛрд╕реНрддреА рдХрд░ рдмреИрдареА рдереАрдВ... рдЬрд┐рдиреНрди рдиреЗ рдЙрдирдХреА рдЬрд╝рд┐рдВрджрдЧреА рдореЗрдВ рдмрд╣реБрдд рдкрд░реЗрд╢рд╛рдирд┐рдпрд╛рдБ рдкреИрджрд╛ рдХреАрдВ... рдФрд░ рдЖрдЦрд┐рд░рдХрд╛рд░, рдЙрдирдХреА рдореМрдд рд╣реЛ рдЧрдИред\n\nрдкрд╛рд░рд╕ рдиреЗ рдореБрдЭреЗ рдПрдХ рдХрд╣рд╛рдиреА рд╕реБрдирд╛рдИ... рдкрд╛рд░рд╕ рдиреЗ рдмрддрд╛рдпрд╛ рдХрд┐ рд╡реЛ рдПрдХ рдмрд╛рд░ рдЕрдкрдиреЗ рджреЛрд╕реНрддреЛрдВ рдХреЗ рд╕рд╛рде рдЬрдВрдЧрд▓ рдореЗрдВ рдЬрд╛ рд░рд╣рд╛ рдерд╛... рд░рд╛рдд рдореЗрдВ, рдЙрдиреНрд╣реЗрдВ рд▓рдЧрд╛ рдХрд┐ рдЙрдирдХреА рдХрд╛рд░ рдХрд╛ рдЯрд╛рдпрд░ рдкрдВрдХреНрдЪрд░ рд╣реЛ рдЧрдпрд╛ рд╣реИ... рдЙрдиреНрд╣реЛрдВрдиреЗ рдХрд╛рд░ рд░реЛрдХреА рдФрд░ рдЯрд╛рдпрд░ рдмрджрд▓рдиреЗ рд▓рдЧреЗ... рд▓реЗрдХрд┐рди рдЬрдм рдЙрдиреНрд╣реЛрдВрдиреЗ рдЯрд╛рдпрд░ рджреЗрдЦрд╛ рддреЛ рд╡реЛ рдмрд┐рд▓реНрдХреБрд▓ рдареАрдХ рдерд╛... рдЙрдиреНрд╣реЗрдВ рд╕рдордЭ рдореЗрдВ рдЖ рдЧрдпрд╛ рдХрд┐ рдпрд╣ рдХрд┐рд╕реА рднреВрдд рдХрд╛ рдХрд╛рдо рд╣реИ...\n\nрд╡рд┐рдХреНрдХреА рдирд╛рдо рдХреЗ рдПрдХ рд▓рдбрд╝рдХреЗ рдиреЗ рдореБрдЭреЗ рдПрдХ рдХрд╣рд╛рдиреА рд╕реБрдирд╛рдИ... рд╡рд┐рдХреНрдХреА рдиреЗ рдмрддрд╛рдпрд╛ рдХрд┐ рдЙрд╕рдХрд╛ рдЫреЛрдЯрд╛ рднрд╛рдИ рдПрдХ рдмрд╛рд░ рдмреБрд░реА рдЖрддреНрдорд╛ рдХреЗ рдЪрдкреЗрдЯ рдореЗрдВ рдЖ рдЧрдпрд╛ рдерд╛... рдЙрд╕рдХреЗ рднрд╛рдИ рдХреЗ рд╕рд╛рде рдЕрдЬреАрдм рдЪреАрдЬреЗрдВ рд╣реЛрдиреЗ рд▓рдЧреАрдВ... рд╡реЛ рдЕрдЬреАрдм-рдЕрдЬреАрдм рдмрд╛рддреЗрдВ рдХрд░рддрд╛ рдерд╛... рд╡реЛ рд▓реЛрдЧреЛрдВ рдХреЛ рдорд╛рд░рдиреЗ рдХреА рдзрдордХреА рджреЗрддрд╛ рдерд╛... рд╡рд┐рдХреНрдХреА рдХреЗ рдкрд░рд┐рд╡рд╛рд░ рдиреЗ рдПрдХ рдмрд╛рдмрд╛ рдХреЛ рдмреБрд▓рд╛рдпрд╛, рдФрд░ рдЙрдиреНрд╣реЛрдВрдиреЗ рдЙрд╕рдХреЗ рднрд╛рдИ рдХреЛ рдареАрдХ рдХрд┐рдпрд╛ред\n\nрддреЛ рджреЛрд╕реНрддреЛрдВ, рдпреЗ рдереАрдВ рдХреБрдЫ рдбрд░рд╛рд╡рдиреА рдХрд╣рд╛рдирд┐рдпрд╛рдБ рдЬреЛ рд▓реЛрдЧреЛрдВ рдиреЗ рдореЗрд░реЗ рд╕рд╛рде рд╢реЗрдпрд░ рдХреАрдВ... рдореБрдЭреЗ рдЙрдореНрдореАрдж рд╣реИ рдХрд┐ рдЖрдкрдХреЛ рдпреЗ рдХрд╣рд╛рдирд┐рдпрд╛рдБ рдкрд╕рдВрдж рдЖрдИ рд╣реЛрдВрдЧреАред рдЕрдЧрд░ рдЖрдкрдХреЗ рдкрд╛рд╕ рднреА рдХреЛрдИ рдРрд╕реА рдХрд╣рд╛рдиреА рд╣реИ, рддреЛ рдЬрд╝рд░реВрд░ рдмрддрд╛рдЗрдПрдЧрд╛ред рдЕрдЧрд▓реА рдмрд╛рд░, рд╢рд╛рдпрдж рдЖрдкрдХреА рдХрд╣рд╛рдиреА рдореИрдВ рд╕реБрдирд╛рдКрдБ... рдзрдиреНрдпрд╡рд╛рдж!",
  // };
  // let parsed = aiOutput;
  // try {
  //   parsed = JSON.parse(aiOutput); // тЬЕ use JSON.parse, not JSON5
  // } catch (err) {
  //   console.error("тЭМ JSON parse failed:", aiOutput);
  //   throw err;
  // }

  // console.log(`тЬЕ Part ${JSON.stringify(parsed, null, 2)}`);
  const data = JSON.stringify(aiOutput, null, 2);
  const { title, story, youtube_tags, image_tags } = await getMetaData(data);
  const imageTags = await cleanArrayString(image_tags);
  const youtubeTags = await cleanArrayString(youtube_tags);
  const cleanStory = await cleanAndParagraph(story || "");
  await fetchAndDownloadImages(image_tags);
  console.log("YT", youtube_tags, title, cleanStory, image_tags);
  await sleep(2000 + Math.random() * 3000); // 2000тАР5000тАпms
  await saveToFile(`storyScript_AI/${title}`, `AI_Story_${slug}`, cleanStory);
  await updateExcel(slug, {
    status: "refined",
    aiTitle: title,
    imageTag: imageTags,
    youtubeTag: youtubeTags,
  });
}
